"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Path=require("path"),Fs=require("fs"),nodeHtmlParser=require("node-html-parser");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var Path__default=_interopDefaultLegacy(Path),Fs__default=_interopDefaultLegacy(Fs),ErrorId={10001:"pages.json文件解析异常, 请查看抛出的异常信息",10101:"App.vue文件中未找到<view-router />标签",10102:"App.vue文件中<view-router />标签数量超过1个以上",10201:"运行环境异常"},name="uniapp-router-view-loader",version="1.0.1";const publicPath="../../../",provideKey="$urvl";var Config=Object.freeze({__proto__:null,publicPath:publicPath,provideKey:provideKey,name:name,version:version});const consoleStyle=()=>[`\`
 %c ${name} V${version} `.concat("%c url: 965.ink/uniapp-router-view-loader \n`"),"'color: #ffffff; background: #64b587; padding:5px 0;'","'color: #fff;background: #38485c; padding:5px 0; margin-left:-1px;'"],getPath=e=>Path__default.default.join(__dirname,"../",...e),getFileMatchReg=function(e,t){e=getPath([e,"/"+t]);const r=JSON.stringify(`^${e}.(n)?vue$`);return new RegExp(r.substring(1,r.length-1))},getRouteFileMatchRegAll=function(r){try{const e=Fs__default.default.readFileSync(getPath([r.publicPath,"./pages.json"]),"utf8"),{pages:t,subPackages:a=[]}=JSON.parse(e.replace(/\/\/[ \S\t]+/g,"")),o=[];return t.forEach(({path:e})=>{o.push(getFileMatchReg(r.publicPath,e))}),a.forEach(({pages:e,root:t})=>{e.forEach(({path:e})=>{o.push(getFileMatchReg(r.publicPath,t+"/"+e))})}),o}catch(e){console.log(e),print("error",ErrorId[10001])}},addCodeToHeader=function(e,t){return e.replace(/<view(.*?)>/,e=>e+t)},addCodeToFooter=function(e,t){return e.replace(/(<\/view>)([\s|S]+)(<\/template>)/,e=>t+e)},handleAppTemplateAddCode=function(e){let t="";switch(process.env.UNI_PLATFORM){case"h5":var r=e.replace(/(?<=<\/template>)[\w\W]*<\/template>/,e=>(t=e,"")).match(/<template>[\s\S]+<\/template>/)[0];return{source:e=e.replace(/<template>[\s\S]+<\/template>/,r),addCode:t};case"mp-weixin":case"mp-alipay":case"mp-baidu":case"mp-toutiao":case"mp-kuaishou":case"mp-lark":case"mp-qq":case"mp-360":case"quickapp-webview":case"app-plus":case"vite":return{source:e=e.replace(/<template>[\s\S]+<\/template>/,e=>(t=e,"")),addCode:t};default:print("error",ErrorId[10201])}},handleGetTemplateRowCode=function(e){e=e.replace(/<(\/?)template>/g,"");const t=nodeHtmlParser.parse(e).querySelectorAll("> *").toString().split(",");return t.map(e=>e.replace(/\n\s+/g,""))},handleGetTemplateHeaderOrFooterLabelCode=function(e){const t=/<view-router(\s{0,})><\/view-router>/,r=[],a=[];let o=!1,n=0;return e.forEach(e=>{if(t.test(e))return o=!0,n++,!0;(o?a:r).push(e)}),0===n?print("error",ErrorId[10101]):1<n&&print("error",ErrorId[10102]),{header:r,footer:a}},getPrintID=function(){return`[${name}]:`},print=function(e="log",t){var r=getPrintID();switch(e){case"log":console.log(""+r+t);break;case"error":throw new Error(""+r+t)}};let addLabel={header:[],footer:[]};function getConfigure(e){e=Object.assign({},Config,e,{publicPath:publicPath+e.publicPath});return{config:e,routeFilePathRegList:getRouteFileMatchRegAll(e)}}function handleAppVue(e){print("App.vue file match, process: ",process.env.UNI_PLATFORM);var t=handleAppTemplateAddCode(e),r=handleGetTemplateRowCode(t.addCode),r=handleGetTemplateHeaderOrFooterLabelCode(r);return e=t.source,e+="<script>console.log("+consoleStyle()+")<\/script>",addLabel=Object.assign(addLabel,r),e}function handleRouteFile(e,t){return print("route file match: ",t),e=addCodeToHeader(e,addLabel.header.join("")),e=addCodeToFooter(e,addLabel.footer.join(""))}function index(e){const{config:t,routeFilePathRegList:r}=getConfigure(this.query);return this.resourcePath===getPath([t.publicPath,"/App.vue"])&&(e=handleAppVue(e)),e=r.some(e=>e.test(this.resourcePath))?handleRouteFile(e,this.resourcePath):e}function vitePlugin(e){const{config:a,routeFilePathRegList:o}=getConfigure(e);return{name:name,enforce:"pre",transform(e,t){var r;return t===getPath([a.publicPath,"/App.vue"])?(r=process.env.UNI_PLATFORM,process.env.UNI_PLATFORM="vite",e=handleAppVue(e),process.env.UNI_PLATFORM=r,{code:e}):o.some(e=>e.test(t))?{code:e=handleRouteFile(e,t)}:void 0}}}exports.default=index,exports.vitePlugin=vitePlugin;
